<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aaa.fresh.mapper.StockChangeMapper">
    <resultMap id="stockChangeDataMap" type="StockChangeData">
        <result column="id" jdbcType="VARCHAR" property="id" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="stock_change_direction" jdbcType="VARCHAR" property="stockChangeDirection" />
        <result column="stock_change_type" jdbcType="VARCHAR" property="stockChangeType" />
        <result column="warehouse" jdbcType="VARCHAR" property="warehouse" />
        <result column="operator" jdbcType="VARCHAR" property="operator" />
        <result column="reference_id" jdbcType="VARCHAR" property="referenceId" />
        <result column="check_in_time" jdbcType="DATE" property="checkInTime" />
        <result column="create_time" jdbcType="DATE" property="createTime" />
        <result column="owner" jdbcType="VARCHAR" property="owner" />
        <result column="version" jdbcType="INTEGER" property="version" />
        <result column="productId" jdbcType="VARCHAR" property="productId"/>
    </resultMap>
    <!--获取所有的条数-->

    <sql id="sel">
        <if test="id != null and id != ''">
            AND a.ID = #{id}
        </if>
        <if test="name != null and name != ''">
            AND a.NAME = #{name}
        </if>
        <if test="warehouse != null and warehouse != ''">
            AND a.WAREHOUSE = #{warehouse}
        </if>
        <if test="operator != null and operator != ''">
            AND a.OPERATOR = #{operator}
        </if>
        <if test="stockChangeDirection != null and stockChangeDirection != ''">
            AND a.STOCK_CHANGE_DIRECTION = #{stockChangeDirection}
        </if>
        <if test="stockChangeType != null and stockChangeType != ''">
            AND a.STOCK_CHANGE_TYPE = #{stockChangeType}
        </if>
    </sql>
    <select id="getTotal" parameterType="StockChangeData" resultType="Long">
        SELECT COUNT(*) FROM supplychain.stock_change_data a
        <where>
            <include refid="sel"/>
        </where>
    </select>

    <!--查询所有的-->
    <select id="selAllStockChange" parameterType="StockChangeData" resultMap="stockChangeDataMap">
        SELECT a.ID, a.NAME, c.NAME STOCK_CHANGE_DIRECTION, b.NAME STOCK_CHANGE_TYPE, a.WAREHOUSE, a.OPERATOR, a.REFERENCE_ID, a.CHECK_IN_TIME, a.CREATE_TIME, a.OWNER `owner`, a.VERSION
        FROM supplychain.stock_change_data a,
             supplychain.stock_change_type_data b,
             supplychain.stock_change_direction_data c
        WHERE a.STOCK_CHANGE_DIRECTION = c.ID AND
              a.STOCK_CHANGE_TYPE = b.ID
            <include refid="sel"/>
        <if test="page != null and size != null">
            limit #{page},#{size}
        </if>
    </select>

    <!--查询单个-->
    <select id="selOneStockChange" parameterType="String" resultMap="stockChangeDataMap">
        SELECT a.ID, a.NAME, c.NAME STOCK_CHANGE_DIRECTION, b.NAME STOCK_CHANGE_TYPE, a.WAREHOUSE, a.OPERATOR, a.REFERENCE_ID, a.CHECK_IN_TIME, a.CREATE_TIME, a.OWNER, a.VERSION
        FROM supplychain.stock_change_data a,
             supplychain.stock_change_type_data b,
             supplychain.stock_change_direction_data c
        WHERE a.STOCK_CHANGE_DIRECTION = c.ID AND
              a.STOCK_CHANGE_TYPE = b.ID and
              a.ID = #{Id}


    </select>

    <!--修改-->
    <update id="updStockChange" parameterType="StockChangeData">
        UPDATE supplychain.stock_change_data
        <set>
            <if test="name != null and name != ''">
                NAME = #{name},
            </if>
            <if test="stockChangeDirection != null and stockChangeDirection != ''">
                STOCK_CHANGE_DIRECTION = #{stockChangeDirection},
            </if>
            <if test="stockChangeType != null and stockChangeType != ''">
                STOCK_CHANGE_TYPE = #{stockChangeType},
            </if>
            <if test="warehouse != null and warehouse != ''">
                WAREHOUSE = #{warehouse},
            </if>
            <if test="operator != null and operator != ''">
                OPERATOR = #{operator},
            </if>
            <if test="referenceId != null and referenceId != ''">
                REFERENCE_ID = #{referenceId},
            </if>
        </set>
        WHERE ID = #{id}
    </update>

    <!--添加-->
    <insert id="addStockChange" parameterType="StockChangeData">
        INSERT INTO supplychain.stock_change_data
        (ID, NAME, STOCK_CHANGE_DIRECTION, STOCK_CHANGE_TYPE, WAREHOUSE, OPERATOR,REFERENCE_ID, CHECK_IN_TIME, CREATE_TIME, OWNER, VERSION)
        VALUES(#{id}, #{name}, #{stockChangeDirection}, #{stockChangeType}, #{warehouse}, #{operator},#{referenceId},  NOW(), NOW(),#{owner},  1)

    </insert>
    
    <!--删除-->
    <delete id="delStockChange" parameterType="String">
        DELETE FROM supplychain.stock_change_data
        WHERE ID = #{id}
    </delete>

    <!--查询查询库存变化的方向-->
    <resultMap id="stockChangeDirectionDataMap" type="StockChangeDirectionData">
        <result column="id" jdbcType="VARCHAR" property="id" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="code" jdbcType="VARCHAR" property="code" />
        <result column="platform" jdbcType="VARCHAR" property="platform" />
        <result column="version" jdbcType="INTEGER" property="version" />
    </resultMap>
    <select id="selAllDirectinon" resultMap="stockChangeDirectionDataMap">
        SELECT ID, NAME, CODE, PLATFORM, VERSION
        FROM supplychain.stock_change_direction_data
    </select>

    <!--库存变化类型-->
    <resultMap id="stockChangeTypeDataMap" type="StockChangeTypeData">
        <result column="id" jdbcType="VARCHAR" property="id" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="code" jdbcType="VARCHAR" property="code" />
        <result column="platform" jdbcType="VARCHAR" property="platform" />
        <result column="version" jdbcType="INTEGER" property="version" />
    </resultMap>
    <select id="selAllChangeType" resultMap="stockChangeTypeDataMap">
        SELECT ID, NAME, CODE, PLATFORM, VERSION
        FROM supplychain.stock_change_type_data
    </select>

    <!--根据引用id查询详细的出入库信息-->
    <resultMap id="stockChangeItemDataMap" type="StockChangeItemData">
        <result column="id" jdbcType="VARCHAR" property="id" />
        <result column="name" jdbcType="VARCHAR" property="name" />
        <result column="product" jdbcType="VARCHAR" property="product" />
        <result column="stock_lot_number" jdbcType="VARCHAR" property="stockLotNumber" />
        <result column="quantity" jdbcType="DOUBLE" property="quantity" />
        <result column="stock_check_in" jdbcType="VARCHAR" property="stockCheckIn" />
        <result column="version" jdbcType="INTEGER" property="version" />
        <result column="unit" jdbcType="VARCHAR" property="unit"/>
        <result column="poductId" jdbcType="VARCHAR" property="poductId"/>
    </resultMap>
    <select id="selChangeItemById" parameterType="String" resultMap="stockChangeItemDataMap">
        SELECT a.ID, a.NAME, b.name PRODUCT, a.STOCK_LOT_NUMBER,
               a.QUANTITY, a.STOCK_CHECK_IN, a.VERSION,
               a.PRODUCT productId,c.name unit, a.PRODUCT poductId
        FROM supplychain.stock_change_item_data a,
             supplychain.product_data b,
             supplychain.MEASURE_UNIT_DATA c
        WHERE a.ID = #{Id} and a.product = b.id and b.MEASURE_UNIT = c.ID
    </select>

    <!--修改出入库的状态 默认为0 为未领取  修改值为1 状态为 已领取 减少库存-->
    <update id="updChangeItemVersion" >
        UPDATE supplychain.stock_change_item_data
        SET  VERSION = #{version}
        WHERE ID = #{Id}
    </update>
    <!--管理员修改审批状态-->
    <update id="updChangeVersion" >
        UPDATE supplychain.stock_change_data
        SET  VERSION = #{version}
        WHERE ID = #{Id}
    </update>
</mapper>